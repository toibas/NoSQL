<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Elasticsearch Log Analyse</title>
</head>
<body>
  <h1>Elasticsearch Log Analyse</h1>

  <section>
    <h2>Verbindung testen</h2>
    <button onclick="testAPI()">API erreichbar?</button>
    <button onclick="testDatabase()">Elasticsearch erreichbar?</button>
    <pre id="testResult"></pre>
  </section>

  <section>
    <h2>Log-Datei hochladen (.log oder .json)</h2>
    <input type="file" id="logfileInput" />
    <button onclick="uploadLog()">Hochladen</button>
    <pre id="uploadResult"></pre>
  </section>

  <section>
    <h3>Logs löschen</h3>
    <button onclick="deleteLogs()">Alle Logs löschen</button>
    <pre id="deleteResult"></pre>
  </section>

  <section>
    <h2>Zur Analyse-Seite</h2>
    <button onclick="window.location.href='analyse.html'">Zur Analyse</button>
  </section>

  <section>
    <h2>Benutzername ändern</h2>
    <p id="currentUserInfo"></p>
    <input type="text" id="newUsername" placeholder="Neuer Benutzername" />
    <button onclick="updateUsername()">Ändern</button>
    <pre id="updateUserResult"></pre>
  </section>  

  <script src="config.js"></script>
  <script src="utils.js"></script>
  <script>
  /**
    * Zeigt aktuelle User-Infos aus localStorage an.
    * @returns {void}
    */
    function renderCurrentUser() {
      const uid = localStorage.getItem("userId");
      const uname = localStorage.getItem("username");
      const el = document.getElementById("currentUserInfo");
      el.textContent = `Angemeldet als: ${uname} (ID: ${uid})`;
    }

    /**
    * Sendet PATCH zum Aktualisieren des Benutzernamens.
    * @returns {Promise<void>}
    */
    async function updateUsername() {
      const uid = localStorage.getItem("userId");
      if (!uid) {
        showResult("updateUserResult", "Keine User-ID gefunden. Bitte einloggen.");
        return;
      }
      const newUsername = document.getElementById("newUsername").value;
      if (!newUsername) {
        showResult("updateUserResult", "Bitte neuen Benutzernamen eingeben.");
        return;
      }

      const res = await apiCall(`${API_BASE}/user/${uid}`, "PATCH", { username: newUsername });
      if (res.success) {
        // localStorage aktualisieren und Anzeige refreshen
        localStorage.setItem("username", res.data.username || newUsername);
        renderCurrentUser();
      }
      showResult("updateUserResult", res.data?.message || res.data?.error || res.error || res);
    }

    renderCurrentUser();

    /**
     * Testet, ob die API erreichbar ist und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function testAPI() {
      const res = await apiCall(`${API_BASE}/`);
      showResult('testResult', res.data || res.error);
    }

    /**
     * Testet, ob Elasticsearch erreichbar ist und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function testDatabase() {
      const res = await apiCall(`${API_BASE}/test`);
      showResult('testResult', res.data || res.error);
    }

    /**
     * Löscht alle Logs aus der Datenbank und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function deleteLogs() {
      const res = await apiCall(`${API_BASE}/delete-logs`, "DELETE");
      showResult("deleteResult", res.data.message || res.data.error || res.data);
    }

    /**
     * Lädt eine Logdatei hoch und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function uploadLog() {
      const file = document.getElementById('logfileInput').files[0];
      if (!file) return alert("Bitte Datei auswählen");

      const formData = new FormData();
      formData.append("logfile", file);

      const res = await apiCall(`${API_BASE}/upload-log`, "POST", formData);
      showResult("uploadResult", res.data.message || res.data.error || res.data);
    }

  </script>
</body>
</html>
