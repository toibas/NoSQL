<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Elasticsearch Log Analyse</title>
</head>
<body>
  <h1>Elasticsearch Log Analyse</h1>

  <section>
    <h2>Verbindung testen</h2>
    <button onclick="testAPI()">API erreichbar?</button>
    <button onclick="testDatabase()">Elasticsearch erreichbar?</button>
    <pre id="testResult"></pre>
  </section>

  <section>
    <h2>Log-Datei hochladen (.log oder .json)</h2>
    <input type="file" id="logfileInput" />
    <button onclick="uploadLog()">Hochladen</button>
    <pre id="uploadResult"></pre>
  </section>

  <section>
    <h3>Logs löschen</h3>
    <button onclick="deleteLogs()">Alle Logs löschen</button>
    <pre id="deleteResult"></pre>
  </section>

  <section>
    <h2>Zur Analyse-Seite</h2>
    <button onclick="window.location.href='analyse.html'">Zur Analyse</button>
  </section>

  <section>
    <h2>Benutzername ändern</h2>
    <p id="currentUserInfo"></p>
    <input type="text" id="newUsername" placeholder="Neuer Benutzername" />
    <button onclick="updateUsername()">Ändern</button>
    <pre id="updateUserResult"></pre>
  </section>  

  <script src="config.js"></script>
  <script src="utils.js"></script>
  <script>

    loadCurrentUser();
  /**
    * Zeigt aktuelle User-Infos aus localStorage an.
    * @returns {void}
    */
    function loadCurrentUser() {
      const userId = localStorage.getItem("userId");
      const username = localStorage.getItem("username");
      const element = document.getElementById("currentUserInfo");
      element.textContent = `Angemeldet als: ${username} (ID: ${userId})`;
    }

    /**
    * Sendet PATCH zum Aktualisieren des Benutzernamens.
    * @returns {Promise<void>}
    */
    async function updateUsername() {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        showResult("updateUserResult", "Keine User-ID gefunden. Bitte einloggen.");
        return;
      }
      const newUsername = document.getElementById("newUsername").value;
      if (!newUsername) {
        showResult("updateUserResult", "Bitte neuen Benutzernamen eingeben.");
        return;
      }

      const result = await apiCall(`${API_BASE}/user/${userId}`, "PATCH", { username: newUsername });
      if (result.success) {
        // localStorage aktualisieren und Anzeige refreshen
        localStorage.setItem("username", result.data.username || newUsername);
        loadCurrentUser();
      }
      showResult("updateUserResult", result.data?.message || result.data?.error || result.error || result);
    }

    /**
     * Testet, ob die API erreichbar ist und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function testAPI() {
      const result = await apiCall(`${API_BASE}/`);
      showResult('testResult', result.data || result.error);
    }

    /**
     * Testet, ob Elasticsearch erreichbar ist und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function testDatabase() {
      const result = await apiCall(`${API_BASE}/test`);
      showResult('testResult', result.data || result.error);
    }

    /**
     * Löscht alle Logs aus der Datenbank und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function deleteLogs() {
      const result = await apiCall(`${API_BASE}/delete-logs`, "DELETE");
      showResult("deleteResult", result.data.message || result.data.error || result.data);
    }

    /**
     * Lädt eine Logdatei hoch und zeigt das Ergebnis an.
     * @returns {Promise<void>} Es wird nichts zurückgegeben, das Ergebnis wird angezeigt.
     */
    async function uploadLog() {
      const file = document.getElementById('logfileInput').files[0];
      if (!file) return alert("Bitte Datei auswählen");

      const formData = new FormData();
      formData.append("logfile", file);

      const result = await apiCall(`${API_BASE}/upload-log`, "POST", formData);
      showResult("uploadResult", result.data.message || result.data.error || result.data);
    }

  </script>
</body>
</html>
